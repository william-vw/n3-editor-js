<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>SiN3: SPARQL in N3</title>

	<script src="/n3/editor/lib/jquery-3.5.1.min.js"></script>
	<script src="/n3/editor/lib/shortcut.js"></script>

	<script src="/n3/editor/codemirror-5.54.0/lib/codemirror.js"></script>
	<link rel="stylesheet" href="/n3/editor/codemirror-5.54.0/lib/codemirror.css">
	<link rel="stylesheet" href="/n3/editor/codemirror-5.54.0/addon/lint/lint.css">
	<script src="/n3/editor/codemirror-5.54.0/addon/lint/lint.js"></script>
	<script src="/n3/editor/codemirror-5.54.0/addon/edit/matchbrackets.js"></script>
	<script src="/n3/editor/codemirror-5.54.0/addon/display/placeholder.js"></script>

	<!-- introduces n3 namespace -->
	<script src="/n3/editor/dist/n3Main.js"></script>

	<script src="/n3/editor/lib/codemirror-5.54.0/namespaces.js"></script>
	<script src="/n3/editor/lib/codemirror-5.54.0/lint.js"></script>
	<script src="/n3/editor/lib/codemirror-5.54.0/n3-mode.js"></script>
	<link rel="stylesheet" href="/n3/editor/lib/codemirror-5.54.0/rdf.css">

	<script src="/n3/config.js"></script>
	<script src="/n3/editor/lib/utils.js" type="text/javascript"></script>

	<link rel="stylesheet" href="/n3/editor/lib/spin3.css">

	<!--	Syntaxica Code Editor -->
	<script defer="defer" src="/n3/editor/lib/syntaxica/editor.js"></script>

	<style>
		@font-face {
			font-family: 'jetbrains-mono';
			src: url('/n3/editor/lib/syntaxica/fonts/jetbrains-mono.ttf');
		}

		@font-face {
			font-family: 'roboto';
			src: url('/n3/editor/lib/syntaxica/fonts/roboto.ttf');
		}
	</style>

	<script>
		const formats = {
			n3: { type: 'n3', label: "<u>N</u>3", lib: n3, mode: 'n3' },
			none: { type: 'none', label: "N<u>o</u>ne" }
		}
		const defaultFormat = formats.n3

		var editor = null
		function getFormula() {
			if (editor != null)
				return editor.getDoc().getValue()
			else
				return $('textarea#data').val()
		}

		function getCurrentFormat() {
			return defaultFormat;
		}

		// function code_link(label, code) {
		// 	const el = $(`<a href="#">${label}</a>`)
		// 	el.click(() => {
		// 		const w = window.open("", "_blank")
		// 		w.document.body.innerText = code
		// 		w.document.close()
		// 	})

		// 	return el
		// }

		function exec() {
			var sparql = $('textarea#code-textarea--input').val()
			if (sparql.length == 0) {
				console.log("empty SPARQL - ignoring");
				showError("Please enter some SPARQL CONSTRUCT queries.")
				return;
			}

			var data = getFormula()
			if (data.length == 0) {
				console.log("empty data - ignoring");
				showError("Please enter some data to reason over.")
				return;
			}

			var task = 'spin3';

			// var taskEl = $("select[name=reason_task] :selected");
			// var taskId = taskEl.attr('id');
			var taskId = 'deriv'

			// var subTask = taskEl.val();
			var subTask = 'derivations'
			if (!subTask)
				return;

			$(".output").hide()

			service.exec({
				task: task,
				subTask: subTask,
				query: sparql,
				data: data

			}, (success) => {
				// console.log(success);

				$('#links').show()
				// $(`#spin_link`).html(code_link("View SPIN", success.spin));
				// $(`#n3_link`).html(code_link("View N3", success.n3));
				$(`#spin_link`).attr('href', `/n3/${success.spin}`);
				$(`#n3_link`).attr('href', `/n3/${success.n3}`);

				const info = success.info;
				$('#info').show();
				const numFilters = info.numFilters
				const numConstructs = info.numConstructs
				$('#info').html(
					`Found ${numConstructs} CONSTRUCT quer${numConstructs > 1 ? "ies" : "y"}` + 
					(numFilters == 0 ? "" : ` and ${numFilters} filter${numFilters > 1 ? "s" : ""}`) + ".");

				$('#times').show();
				$('#times').text("(" + success.times.map(t => t + "ms").join(" | ") + ")");

				$(`#${taskId}_out`).show()
				$(`#${taskId}_out > div.box`).text(success.data)

			}, (error) => {
				showError(error)
			})
		}

		function generate_link() {
			$("#error").hide()

			var sparql = $('textarea#code-textarea--input').val()
			if (sparql.length == 0) {
				console.log("empty SPARQL - ignoring");
				showError("Please enter some SPARQL CONSTRUCT queries.")
				return;
			}

			var data = getFormula()
			if (data.length == 0) {
				showError("Please enter some N3 data.")
				return;
			}

			formula = "sparql=" + sparql + "\n\nn3=" + data

			if (formula.length > config.link.max_len) {
				$("#linkPlaceholder").html(`Formula too long (max. length: ${config.link.max_len})`)
				return false
			}

			var format = getCurrentFormat().type
			var base = "/n3/spin3"

			service.generate_link(formula, format,
				(id) => {
					let turl = base + "/s/" + id;
					console.log("turl:", turl)

					$("#linkPlaceholder").html("  <a href='" + turl + "'>Link</a>")

				}, (error) => {
					$("#error").show().find("#output").html(error)
				})

			return true
		}

		function resolve_link(id) {
			service.resolve_link(id,
				(data) => {
					// console.log("resolved:", data);

					var formula = data.formula
					if (!formula.startsWith("sparql=")) {
						console.error("wrong formula link for spin3")
						return
					}

					var matches = formula.match(/sparql=([^]*)\n\nn3=([^]*)/)
					var sparql = matches[1];
					var n3 = matches[2];

					console.log("initializing formula from link")

					$('textarea#code-textarea--input').val(sparql);
					editor.getDoc().setValue(n3)

					validate(defaultFormat, true)

				}, (error) => {
					$("#error").show().find("#output").html(error)
				})
		}

		// https://stackoverflow.com/questions/19979741/codemirror-delete-a-editor-instance

		function validate(format, setInput) {
			if (format.type == "none")
				stopValidating(setInput)
			else
				startValidating(format, setInput)
		}

		var alreadySuggested = []

		const onSuggestion = {
			namespace: function (prefix, ns) {
				// if (!$("#auto-ns").prop('checked'))
				// 	return false

				console.log("prefix suggestion:", prefix, ":", ns)
				if (alreadySuggested.includes(prefix)) {
					console.log("already suggested")
					return false
				}

				alreadySuggested.push(prefix)
				var insert = `@prefix ${prefix}: <${ns}> .\n`

				const content = editor.getDoc().getValue()
				if (!content.trim().startsWith("@prefix"))
					insert += "\n"

				editor.getDoc().replaceRange(insert, { line: 0, ch: 0 })

				return true
			}
		}

		function startValidating(format, setInput) {
			if (setInput)
				$(`#format_${format.type}`).prop('checked', true)

			if (editor != null)
				stopValidating(false)

			// console.log("format", format);
			editor = CodeMirror.fromTextArea($("#data").get(0), {
				gutters: ["CodeMirror-lint-markers"],
				mode: format.mode,
				theme: "default rdf",
				// TODO this should follow code-mirrors idiom
				// (registering a helper) but not getting that to work
				lint: format.lib.lint(onSuggestion),
				matchBrackets: true
			})
		}

		function stopValidating(setInput) {
			if (setInput)
				$('#format_none').prop('checked', true)

			editor.toTextArea();
			editor = null
		}

		window.loaded = function () {
			// setupFormatInput()
			validate(defaultFormat, true)

			$(document).ajaxStart(startLoading).ajaxStop(doneLoading);

			$("#execute").click(exec)
			shortcut.add("Alt+X", exec)

			$("#share").click(generate_link)
			shortcut.add("Alt+H", generate_link)

			let url = window.location.toString()
			let path = window.location.pathname

			let match = /.*\/s\/([^/]*)/.exec(path)
			if (match) {
				let id = match[1]
				console.log("resolving id:", id);

				resolve_link(id);

			} else if (url.includes("?")) {
				console.error("not supporting formula as URL parameter for spin3");
			}
		}

		// loaded() needs to be called from service.js (see bottom of document)
		// (modules aren't yet loaded when onload event is fired)

		function startLoading() {
			$('.loading').css("display", "inline-block")
		}

		function doneLoading() {
			$('.loading').hide()
		}

		function showError(error) {
			$(".output").hide()

			$("#error_out").show()
			$("#error_out > div.box").html(error)
		}
	</script>
</head>

<body>
	<main>
		<div class="header">
			<table>
				<tr>
					<td>
						<a href="https://github.com/w3c/N3">
							<img class="logo" alt="Notation3 Editor" title="Notation3 Editor" src="/n3/editor/logo-small.png" />
						</a>
					</td>
					<td>
						<div class="functions">
							<div class="function">
								<button id="execute">e<u>x</u>ecute</button>
								<!-- <select name="reason_task">
									<option value="deductive_closure" id="clos">closure</option>
									<option value="derivations" id="deriv" selected>derivations</option>
								</select> -->
							</div>
							<div class="function">
								<button id="share">s<u>h</u>are</button>
								<span id="linkPlaceholder"></span>
							</div>
							<div class="loading">
								<img src="/n3/editor/img/ajax-loader.gif" alt="loader">
							</div>
						</div>
					</td>
				</tr>
			</table>
		</div>

		<div class="content">
			<div class="hint"><b>Hint</b>: each CONSTRUCT query should be separated with a period (".") followed by at least 1 newline.</div>
			<div class="hint"><b>Hint</b>: indicate a query filter by preceding it with "# @filter" and a newline.</div>
			<table>
				<tr>
					<td>
						<div id="syntaxica"></div>
					</td>
					<td>
						<textarea rows=10 cols=50 id="data" placeholder="Data"></textarea>
					</td>
				</tr>
			</table>

			<small class="note2">
				Please submit bugs or feature requests on <a
					href="https://github.com/william-vw/n3-editor-js">GitHub</a>.
			</small>
			<br style="clear: both" />

			<div id="error_out" class="output">
				<h3>Error:</h3>
				<div class="box"></div>
			</div>

			<div id="deriv_out" class="output">
				<div id="info"></div>
				<h3>Results:</h3>
				<div id="links">
					<a class="link" id="spin_link">View SPIN</a>
					<a class="link" id="n3_link">View N3</a>
				</div>
				<div id="times">
				</div>
				<div class="box"></div>
			</div>
		</div>
	</main>

	<script src="/n3/editor/lib/service.js" type="module"></script>
</body>

</html>
